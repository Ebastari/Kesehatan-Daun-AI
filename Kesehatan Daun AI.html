<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>MONTANA â€” Analisis Kesehatan Daun</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
  :root{
    --bg:#0ea5e9; --bg2:#22c55e; --card:#ffffff; --txt:#0f172a; --muted:#64748b;
  }
  *{box-sizing:border-box}
  body{font-family:'Inter',system-ui,Arial,sans-serif;margin:0;background:#f8fafc;color:var(--txt)}
  .hero{background:linear-gradient(135deg,var(--bg),var(--bg2));color:#fff;padding:16px 12px 18px;text-align:center;box-shadow:0 2px 10px rgba(2,6,23,.15)}
  .hero h1{margin:4px 0 6px;font-size:1.2rem}
  .hero .sub{opacity:.95;font-size:.9rem}
  .wrap{padding:12px}
  .row{display:flex;flex-wrap:wrap;gap:12px;justify-content:center}
  .card{background:var(--card);border-radius:14px;box-shadow:0 8px 24px rgba(2,6,23,.06);border:1px solid #eef2f7;padding:12px;width:100%;max-width:400px}
  .title{font-weight:700;font-size:.95rem;margin-bottom:8px}
  video,canvas{border-radius:12px;width:100%;height:auto;max-height:280px;background:#0b0b0b}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  button,.file{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #dbe7f3;background:#fff;cursor:pointer;font-weight:600;font-size:.92rem}
  button:active{transform:scale(.98)}
  .btn-primary{background:#10b981;color:#fff;border-color:#10b981}
  .btn-secondary{background:#e2e8f0}
  .small{font-size:.85rem;color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:6px;font-size:.9rem}
  th,td{border:1px solid #e2e8f0;padding:6px 8px;text-align:left}
  .status-chip{display:inline-flex;align-items:center;gap:6px;font-weight:700;padding:4px 8px;border-radius:999px;border:1px solid #d1d5db}
  .ok{background:#ecfdf5;color:#065f46}
  .bad{background:#fef2f2;color:#7f1d1d}
  .bar{height:10px;background:#eef2f7;border-radius:999px;overflow:hidden;margin-top:6px;outline:1px solid #e5edf6}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,#22c55e,#16a34a);width:0}
  .dominant{background:#f1f5f9;border:1px dashed #cbd5e1;padding:8px;border-radius:10px;margin-top:8px;font-size:.88rem}
  .legend-dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px;vertical-align:middle}
  footer{font-size:.78rem;color:#64748b;text-align:center;padding:10px 0 14px}
</style>
</head>
<body>

<section class="hero">
  <h1>MONTANA â€” Analisis Kesehatan Daun</h1>
  <div class="sub">PT Energi Batubara Lestari â€¢ Teknis Lapangan</div>
</section>

<div class="wrap">
  <div class="row">

    <!-- Kamera / Upload -->
    <div class="card">
      <div class="title">Kamera / Upload</div>
      <video id="video" autoplay playsinline muted></video>
      <canvas id="captureCanvas" width="320" height="320" style="display:none"></canvas>

      <div class="controls">
        <button id="btnStart" class="btn-primary">â–¶ Mulai</button>
        <button id="btnSwitch">ğŸ”„ Ganti</button>
        <button id="btnCapture">ğŸ“· Ambil</button>
        <label class="file" for="upload">â¬†ï¸ Upload</label>
        <input id="upload" type="file" accept="image/*" capture="environment" style="display:none">
        <button id="btnClear" class="btn-secondary">ğŸ§¹ Reset</button>
      </div>
      <div class="small" style="margin-top:6px">Izinkan akses kamera. Jika tidak tersedia, gunakan Upload.</div>
    </div>

    <!-- Analisis & Skor -->
    <div class="card">
      <div class="title">Analisis Visual & Skor</div>
      <canvas id="displayCanvas" width="320" height="320" style="background:#eef2f7;"></canvas>

      <div style="display:flex;align-items:center;gap:12px;margin-top:10px;flex-wrap:wrap">
        <div style="flex:1;min-width:180px">
          <div class="small">Skor Kesehatan</div>
          <div style="display:flex;align-items:center;gap:8px;margin-top:2px">
            <span id="statusChip" class="status-chip ok" style="display:none">âœ” Sehat</span>
            <span id="statusChipBad" class="status-chip bad" style="display:none">âš  Tidak Sehat</span>
            <div id="score" style="font-size:1.25rem;font-weight:800">â€”</div>
          </div>
          <div class="bar"><span id="scoreBar"></span></div>
          <div id="healthLabel" class="small" style="margin-top:6px">â€”</div>
        </div>

        <div style="width:180px;min-width:160px">
          <canvas id="chart" width="180" height="160"></canvas>
        </div>
      </div>

      <div class="dominant" id="dominantBox" style="display:none"></div>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="btnDownloadPDF" class="btn-primary">â¬‡ Unduh Laporan (PDF)</button>
      </div>
    </div>

    <!-- Rincian & Saran -->
    <div class="card">
      <div class="title">Rincian Hasil</div>
      <table>
        <thead><tr><th>Kategori</th><th>Count</th><th>%</th></tr></thead>
        <tbody id="tableBody">
          <tr><td><span class="legend-dot" style="background:#16a34a"></span>Hijau (Sehat)</td><td id="cntSehat">0</td><td id="pctSehat">0%</td></tr>
          <tr><td><span class="legend-dot" style="background:#facc15"></span>Kuning</td><td id="cntKuning">0</td><td id="pctKuning">0%</td></tr>
          <tr><td><span class="legend-dot" style="background:#a855f7"></span>Coklat</td><td id="cntCoklat">0</td><td id="pctCoklat">0%</td></tr>
          <tr><td><span class="legend-dot" style="background:#e5e7eb;border:1px solid #cbd5e1"></span>Putih</td><td id="cntPutih">0</td><td id="pctPutih">0%</td></tr>
          <tr><td><span class="legend-dot" style="background:#111827"></span>Hitam</td><td id="cntHitam">0</td><td id="pctHitam">0%</td></tr>
        </tbody>
      </table>

      <div id="analysisText" class="small" style="margin-top:10px"></div>
      <div id="controlAdvice" class="small" style="margin-top:10px"></div>
      <div id="nutrientNote" class="small" style="margin-top:10px"></div>
    </div>
  </div>
</div>

<footer>
  MONTANA â€” Hasil indikatif; untuk kepastian lakukan uji laboratorium & evaluasi lapangan.
</footer>

<script>
/* ----------------------- Elemen ----------------------- */
const video = document.getElementById('video');
const capCanvas = document.getElementById('captureCanvas');
const cctx = capCanvas.getContext('2d');
const displayCanvas = document.getElementById('displayCanvas');
const dctx = displayCanvas.getContext('2d');
const upload = document.getElementById('upload');

const btnStart = document.getElementById('btnStart');
const btnSwitch = document.getElementById('btnSwitch');
const btnCapture = document.getElementById('btnCapture');
const btnClear = document.getElementById('btnClear');
const btnDownloadPDF = document.getElementById('btnDownloadPDF');

const scoreEl = document.getElementById('score');
const scoreBar = document.getElementById('scoreBar');
const labelEl = document.getElementById('healthLabel');
const chipOk = document.getElementById('statusChip');
const chipBad = document.getElementById('statusChipBad');
const domBox = document.getElementById('dominantBox');

let currentStream = null;
let useFront = false;
let pieChart = null;
let gpsLocation = 'Tidak tersedia';
let lastCounts = {sehat:0,kuning:0,coklat:0,putih:0,hitam:0};
let lastTotal = 0;

/* ----------------------- Kamera ----------------------- */
async function startCamera(){
  if (currentStream) currentStream.getTracks().forEach(t=>t.stop());
  try{
    const s = await navigator.mediaDevices.getUserMedia({ video:{ facingMode: useFront ? 'user':'environment' } });
    currentStream = s; video.srcObject = s;
  }catch(e){ alert('Gagal mengakses kamera. Gunakan Upload gambar.'); }
}
btnStart.onclick = startCamera;
btnSwitch.onclick = ()=>{ useFront=!useFront; startCamera(); };
btnCapture.onclick = ()=>{
  if (!video.videoWidth) { alert('Kamera belum siap'); return; }
  cctx.drawImage(video, 0, 0, capCanvas.width, capCanvas.height);
  runAnalysis();
};

/* ----------------------- Upload ----------------------- */
upload.onchange = (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const reader = new FileReader(); const img = new Image();
  reader.onload = ()=> img.src = reader.result;
  img.onload = ()=>{
    const cw=capCanvas.width, ch=capCanvas.height;
    const r=Math.min(cw/img.width, ch/img.height);
    const w=img.width*r, h=img.height*r;
    const dx=(cw-w)/2, dy=(ch-h)/2;
    cctx.fillStyle='#fff'; cctx.fillRect(0,0,cw,ch);
    cctx.drawImage(img, dx, dy, w, h);
    runAnalysis();
  };
  reader.readAsDataURL(f);
};

/* ----------------------- Reset ----------------------- */
btnClear.onclick = ()=>{
  dctx.fillStyle='#eef2f7'; dctx.fillRect(0,0,displayCanvas.width,displayCanvas.height);
  scoreEl.textContent='â€”'; labelEl.textContent='â€”';
  chipOk.style.display='none'; chipBad.style.display='none';
  scoreBar.style.width='0%';
  ['Sehat','Kuning','Coklat','Putih','Hitam'].forEach(k=>{
    document.getElementById('cnt'+k).textContent='0';
    document.getElementById('pct'+k).textContent='0%';
  });
  domBox.style.display='none'; domBox.innerHTML='';
  ['analysisText','controlAdvice','nutrientNote'].forEach(id=>document.getElementById(id).innerHTML='');
  if (pieChart) { pieChart.destroy(); pieChart=null; }
  lastCounts = {sehat:0,kuning:0,coklat:0,putih:0,hitam:0}; lastTotal=0;
};

/* ------------------- Helper: RGB->HSV ------------------ */
function rgbToHsv(r,g,b){
  r/=255; g/=255; b/=255;
  const max=Math.max(r,g,b), min=Math.min(r,g,b);
  let h=0,s=0,v=max, d=max-min;
  s = max===0 ? 0 : d/max;
  if (d!==0){
    if (max===r) h=((g-b)/d)%6;
    else if (max===g) h=(b-r)/d + 2;
    else h=(r-g)/d + 4;
    h=Math.round(h*60); if (h<0) h+=360;
  }
  return [h,Math.round(s*100),Math.round(v*100)];
}

/* ----------------------- Analisis ---------------------- */
function runAnalysis(){
  dctx.drawImage(capCanvas,0,0,displayCanvas.width,displayCanvas.height);

  const w=capCanvas.width,h=capCanvas.height;
  const img=cctx.getImageData(0,0,w,h); const d=img.data;
  const cnt={sehat:0,kuning:0,coklat:0,putih:0,hitam:0}; let total=0;

  // sampling adaptif: lompat 2 piksel
  for (let i=0;i<d.length;i+=8){
    const r=d[i], g=d[i+1], b=d[i+2], a=d[i+3];
    if (a===0) continue;
    const [H,S,V]=rgbToHsv(r,g,b);
    // Filter background putih terang / gelap
    if ((V>90 && S<20) || (V<10)) continue;

    total++;
    if (H>=60 && H<=160 && S>25 && V>25) cnt.sehat++;
    else if (H>=20 && H<60 && S>20 && V>30) cnt.kuning++;
    else if ((H<40 && S>25 && V<70)) cnt.coklat++;
    else if (V>=85 && S<=20) cnt.putih++;
    else if (V<=15) cnt.hitam++;
    else cnt.coklat++;
  }

  lastCounts=cnt; lastTotal=total;
  overlaySoft(); updateCounts(cnt,total); computeHealthAndAdvice(cnt,total);
}

/* --------------- Overlay lembut tampilan --------------- */
function overlaySoft(){ dctx.fillStyle='rgba(34,197,94,0.12)'; dctx.fillRect(0,0,displayCanvas.width,displayCanvas.height); }

/* ----------------- Update tabel & chart ---------------- */
function updateCounts(cnt,total){
  const pct=k=> total?(cnt[k]/total*100):0;
  [['Sehat','sehat'],['Kuning','kuning'],['Coklat','coklat'],['Putih','putih'],['Hitam','hitam']]
  .forEach(([L,K])=>{
    document.getElementById('cnt'+L).textContent=cnt[K].toLocaleString();
    document.getElementById('pct'+L).textContent=pct(K).toFixed(2)+'%';
  });

  const ctxc=document.getElementById('chart').getContext('2d');
  if (pieChart) pieChart.destroy();
  pieChart=new Chart(ctxc,{type:'doughnut',
    data:{labels:['Hijau','Kuning','Coklat','Putih','Hitam'],
      datasets:[{data:[pct('sehat'),pct('kuning'),pct('coklat'),pct('putih'),pct('hitam')],
        backgroundColor:['#16a34a','#facc15','#a855f7','#e5e7eb','#111827'],borderWidth:0}]},
    options:{cutout:'62%',plugins:{legend:{position:'bottom'},tooltip:{callbacks:{label:(c)=>`${c.label}: ${c.parsed.toFixed(2)}%`}}}}
  });
}

/* ------- Skor + Narasi Dominan + Saran variatif ------- */
function computeHealthAndAdvice(cnt,total){
  const pct=k=> total?(cnt[k]/total*100):0;
  const pHijau=pct('sehat');
  const others=pct('kuning')+pct('coklat')+pct('putih')+pct('hitam');
  let score=pHijau-0.7*others; score=Math.max(0,Math.min(100,score));

  scoreEl.textContent=score.toFixed(2);
  scoreBar.style.width = `${score}%`;
  if (score>50){ chipOk.style.display='inline-flex'; chipBad.style.display='none'; labelEl.innerHTML=`Status: <b>Sehat</b>`; }
  else{ chipOk.style.display='none'; chipBad.style.display='inline-flex'; labelEl.innerHTML=`Status: <b>Tidak Sehat</b>`; }

  const categories={'Hijau (Sehat)':pHijau,'Kuning':pct('kuning'),'Coklat':pct('coklat'),'Putih':pct('putih'),'Hitam':pct('hitam')};
  const dominant=Object.keys(categories).reduce((a,b)=>categories[a]>categories[b]?a:b);
  const domVal=categories[dominant].toFixed(2); const totalPix=total.toLocaleString();

  const intro=`Warna dominan adalah <b>${dominant}</b> dengan persentase sekitar <b>${domVal}%</b> dari <b>${totalPix}</b> piksel daun. `;
  let diagTitle='', cause='', control='', nutrient=''; const pick=a=>a[Math.floor(Math.random()*a.length)];

  if (dominant==='Hijau (Sehat)'){ diagTitle='Tanaman dalam kondisi fisiologis optimal.'; cause='Klorofil memadai dan fotosintesis baik.';
    control=pick(['Pertahankan pola pemupukan & penyiraman.','Pantau daun muda untuk cegah klorosis dini.','Jaga sanitasi dan hindari genangan.']);
    nutrient='Nutrisi makro & mikro seimbang; uji tanah tiap 3â€“6 bulan.';}
  else if (dominant==='Kuning'){ diagTitle='Klorosis â€” defisiensi N/Mg atau stres akar.'; cause='Kekurangan N/Mg atau drainase buruk.';
    control=pick(['Tambahkan pupuk N bertahap.','Perbaiki drainase area akar.','Semprot MgSOâ‚„ 0.5% bila gejala antar tulang.']);
    nutrient='Lakukan uji jaringan untuk konfirmasi N & Mg.';}
  else if (dominant==='Coklat'){ diagTitle='Nekrosis/bercak coklat â€” jamur atau defisiensi K.'; cause='Alternaria/Botrytis atau kekurangan K.';
    control=pick(['Aplikasikan mankozeb/klorotalonil.','Tambah KCl/Kâ‚‚SOâ‚„.','Gunakan paranet saat radiasi tinggi.']);
    nutrient='Kalium memperkuat dinding sel & toleransi stres.';}
  else if (dominant==='Putih'){ diagTitle='Bercak/lapisan putih â€” powdery mildew atau residu.'; cause='Erysiphales pada RH sedangâ€“tinggi atau residu foliar.';
    control=pick(['Gunakan sulfur/kalium bikarbonat pagi/sore.','Tingkatkan sirkulasi udara.','Hindari semprot saat panas terik.']);
    nutrient='Perhatikan mikro Zn & Mn untuk ketahanan.';}
  else { diagTitle='Bercak hitam â€” bakteri/nekrosis berat.'; cause='Jaringan mati; kelembapan tinggi memperparah.';
    control=pick(['Singkirkan & musnahkan daun sakit.','Gunakan bakterisida tembaga.','Perbaiki aerasi tajuk.']);
    nutrient='Pastikan Ca & Si cukup untuk memperkuat jaringan.';}

  if (score<40) control+=' âš ï¸ Skor sangat rendah â€” lakukan uji lab tanah & jaringan.';

  domBox.style.display='block'; domBox.innerHTML=intro;
  document.getElementById('analysisText').innerHTML=`<b>${diagTitle}</b><div style="margin-top:6px">${intro}${cause}</div>`;
  document.getElementById('controlAdvice').innerHTML=`<b>Rekomendasi Pengendalian:</b><div style="margin-top:6px">${control}</div>`;
  document.getElementById('nutrientNote').innerHTML=`<b>Catatan Nutrisi:</b><div style="margin-top:6px">${nutrient}</div>`;

  // simpan data untuk PDF
  window.analysisData = {
    sehat: pHijau.toFixed(2), kuning: pct('kuning').toFixed(2),
    coklat: pct('coklat').toFixed(2), putih: pct('putih').toFixed(2),
    hitam: pct('hitam').toFixed(2), totalPixels: total,
    score: score.toFixed(2), dominant, dominantPct: domVal
  };
}

/* ----------------------- Geolokasi --------------------- */
if (navigator.geolocation){
  navigator.geolocation.getCurrentPosition(p=>{
    gpsLocation = `${p.coords.latitude.toFixed(5)}, ${p.coords.longitude.toFixed(5)}`;
  },()=>{ gpsLocation='Tidak diizinkan'; });
}

/* -------- Util: Chart BW untuk PDF (grayscale) -------- */
function getBWChartDataURL(){
  const a=window.analysisData||{sehat:0,kuning:0,coklat:0,putih:0,hitam:0};
  const tmp=document.createElement('canvas'); tmp.width=220; tmp.height=160;
  const ctx=tmp.getContext('2d');
  new Chart(ctx,{type:'doughnut',
    data:{labels:['Hijau','Kuning','Coklat','Putih','Hitam'],
      datasets:[{data:[a.sehat,a.kuning,a.coklat,a.putih,a.hitam],
        backgroundColor:['#111','#333','#777','#bbb','#000'],borderWidth:0}]},
    options:{responsive:false,animation:false,cutout:'60%',plugins:{legend:{display:false},tooltip:{enabled:false}}}
  });
  return tmp.toDataURL('image/png',1.0);
}

/* --------- Helper PDF: tulis paragraf dinamis ---------- */
function writeParagraph(doc, text, left, y, width=495, size=10, lineGap=2){
  doc.setFontSize(size);
  const lines = doc.splitTextToSize(text, width);
  doc.text(lines, left, y);
  return y + lines.length * (size + lineGap/2);
}

// =============== PDF GENERATOR OTOMATIS & TEKNIS ===============
btnDownloadPDF.onclick = async () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'pt', format: 'a4' });
  const left = 50, right = 545;
  let y = 60;

  /* Helper paragraf */
  function writeTextBlock(text, size = 10, gapAfter = 10) {
    doc.setFontSize(size);
    const lines = doc.splitTextToSize(text, 495);
    doc.text(lines, left, y);
    y += lines.length * (size * 1.45) + gapAfter;
  }

  /* ================= HEADER ================= */
  doc.setFillColor(20);
  doc.rect(0, 0, 595, 55, 'F');
  doc.setFont('helvetica', 'bold');
  doc.setTextColor(255);
  doc.setFontSize(13);
  doc.text('LAPORAN ANALISIS KESEHATAN DAUN â€” TEKNIS LAPANGAN (BW)', 50, 28);
  doc.setFont('helvetica', 'normal');
  doc.setTextColor(240);
  doc.setFontSize(10);
  doc.text('PT Energi Batubara Lestari â€¢ Sistem MONTANA V2', 50, 42);
  doc.setTextColor(0);
  y = 70;

  /* ================= DATA ================= */
  const waktu = new Date().toLocaleString('id-ID', { timeZone: 'Asia/Makassar' });
  const reportId = 'RPT-' + new Date().toISOString().slice(0, 19).replace(/[-:T]/g, '').slice(0, 14);
  const a = window.analysisData || { score: '0', dominant: '-', dominantPct: '0', totalPixels: 0, sehat: 0, kuning: 0, coklat: 0, putih: 0, hitam: 0 };
  const gpsLoc = typeof gpsLocation === 'string' ? gpsLocation : 'Tidak tersedia';
  const scoreNum = parseFloat(a.score);
  const statusTxt = (scoreNum >= 60) ? 'Sehat' : (scoreNum >= 40 ? 'Mulai Stres' : 'Tidak Sehat');

  /* ================= RINGKASAN ================= */
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(11);
  writeTextBlock('Ringkasan Lapangan', 11, 4);
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(10);
  writeTextBlock(`No. Laporan: ${reportId}`);
  writeTextBlock(`Tanggal/Waktu (WITA): ${waktu}`);
  writeTextBlock(`Lokasi (GPS): ${gpsLoc}`);
  writeTextBlock(`Skor: ${a.score} | Status: ${statusTxt}`);
  writeTextBlock(`Dominan: ${a.dominant} (${a.dominantPct}%) | Total Piksel: ${Number(a.totalPixels || 0).toLocaleString()}`, 10, 16);
  doc.line(left, y, right, y);
  y += 20;

  /* ================= FOTO & CHART ================= */
  try {
    const imgData = displayCanvas.toDataURL('image/png', 1.0);
    doc.addImage(imgData, 'PNG', left, y, 230, 230);
  } catch {}
  try {
    const bwChart = getBWChartDataURL();
    doc.addImage(bwChart, 'PNG', left + 250, y, 230, 180);
  } catch {}
  y += 250;
  doc.line(left, y, right, y);
  y += 20;

  /* ================= TABEL ================= */
  const rows = [];
  document.querySelectorAll('#tableBody tr').forEach(tr => {
    const t = tr.querySelectorAll('td');
    rows.push([t[0].innerText, t[1].innerText, t[2].innerText]);
  });
  doc.autoTable({
    head: [['Kategori', 'Count', '%']],
    body: rows,
    startY: y,
    margin: { left },
    styles: { fontSize: 9, lineColor: [180, 180, 180] },
    headStyles: { fillColor: [240, 240, 240], textColor: [0, 0, 0] },
    theme: 'grid'
  });
  y = doc.lastAutoTable.finalY + 20;

  /* ================= FOOTER 1 ================= */
  doc.setFont('helvetica', 'italic');
  doc.setFontSize(9);
  doc.setTextColor(80);
  doc.text('MONTANA HALAMAN  â€” Analisis piksel bersifat indikatif; uji laboratorium tetap lebih akurat.', left, 825);

  /* ================= HALAMAN 2 ================= */
  doc.addPage();
  let y2 = 60;
  function writeBlock(title, text) {
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(11);
    doc.text(title, left, y2);
    y2 += 10;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9.5);
    const lines = doc.splitTextToSize(text, 495);
    doc.text(lines, left, y2);
    y2 += lines.length * 14;
  }

  /* ================= DASAR ILMIAH ================= */
  writeBlock('Dasar Ilmiah Dan Metodologi Analisis',
  `Analisis kesehatan daun berbasis piksel merupakan metode non-destruktif untuk menilai kondisi fisiologis tanaman di lapangan tanpa perlu memetik daun. 
Pendekatan ini mengonversi ruang warna RGB HSV (Hue, Saturation, Value), karena HSV lebih stabil terhadap variasi cahaya dan kontras kamera. 
Setiap piksel citra (320Ã—320) dianalisis untuk menentukan kategori warnanya dengan ambang Hue, Saturation, dan Value yang telah dikalibrasi lapangan.`);

  /* ================= KLASIFIKASI WARNA ================= */
  writeBlock('Prinsip Klasifikasi Warna',
  `Hijau (Sehat): Hue 60â€“160Â°, S>25%, V>25% : jaringan aktif, klorofil tinggi.
Kuning: Hue 20â€“60Â°, S>20%, V>30% : indikasi defisiensi N atau Mg.
Coklat: Hue 0â€“40Â°, S>25%, V<70% :nekrosis jaringan atau jamur.
Putih: S<20%, V>85%  : residu pestisida atau pantulan cahaya.
Hitam: V<15% : jaringan mati atau kelembapan ekstrem.`);

  /* ================= RUMUS ================= */
  writeBlock('Rumus Penilaian Skor Kesehatan',
  `H = P_hijau  0.7 Ã— (P_kuning + P_coklat + P_putih + P_hitam)
Bobot koreksi 0.7 menurunkan pengaruh warna non-hijau. 
Rentang nilai H: 0â€“100, di mana:
H > 80  Sangat Sehat | 60-79 : Sehat | 40-59 : Mulai Stres | <40 : Tidak Sehat.`);

  /* ================= INTERPRETASI OTOMATIS ================= */
  let interpretasi = '';
  if (a.dominant.includes('Coklat')) interpretasi = 'Daun menunjukkan dominasi coklat menandakan defisiensi K dan stres lingkungan.';
  else if (a.dominant.includes('Kuning')) interpretasi = 'Daun mengalami klorosis ringan akibat defisiensi N/Mg atau drainase buruk.';
  else if (a.dominant.includes('Putih')) interpretasi = 'Kemungkinan terdapat residu semprotan atau powdery mildew.';
  else if (a.dominant.includes('Hitam')) interpretasi = 'Jaringan nekrotik akibat kelembapan ekstrem atau infeksi bakteri.';
  else interpretasi = 'Daun dalam kondisi fisiologis stabil dengan aktivitas fotosintesis baik.';

  writeBlock('Interpretasi & Keterbatasan',
  `${interpretasi} Nilai skor ${a.score} (${statusTxt}). 
Hasil bersifat indikatif dan dapat dipengaruhi oleh intensitas cahaya, kualitas kamera, kondisi daun, dan faktor genetik. 
Gunakan hasil ini sebagai deteksi dini sebelum uji jaringan dan analisis tanah untuk konfirmasi laboratorium.`);

  /* ================= KESIMPULAN OTOMATIS ================= */
  let tindakan = '';
  if (a.dominant.includes('Coklat'))
    tindakan = `â€¢ Aplikasi pupuk dosis rendah (1-2 g/liter)
â€¢ Penyemprotan fungisida mankozeb/klorotalonil mingguan
â€¢ Pemantauan visual tiap 3â€“5 hari`;
  else if (a.dominant.includes('Kuning'))
    tindakan = `â€¢ Tambah pupuk N dan Mg
â€¢ Pastikan drainase baik
â€¢ Uji jaringan daun untuk verifikasi nutrisi`;
  else if (a.dominant.includes('Hitam'))
    tindakan = `â€¢ Buang daun rusak
â€¢ Aplikasikan bakterisida tembaga
â€¢ Tingkatkan sirkulasi udara`;
  else
    tindakan = `â€¢ Pertahankan pola pemupukan
â€¢ Monitoring rutin sistem MONTANA
â€¢ Uji jaringan daun per 3 bulan`;

  writeBlock('Kesimpulan Teknis Lapangan',
  `Berdasarkan analisis piksel metode HSV Color Segmentation, tanaman pada titik pengamatan menunjukkan skor ${a.score} (${statusTxt}). 
Warna dominan ${a.dominant} (${a.dominantPct}%) menjadi indikator kondisi fisiologis utama.
Tindakan korektif disarankan:
${tindakan}`);

  /* ================= SPESIFIKASI & REFERENSI ================= */
  writeBlock('Spesifikasi Teknis Sistem',
  `Algoritma: HSV Color Segmentation v1.4
Resolusi Analisis: 320Ã—320 piksel
Sampling: setiap 2 piksel
Toleransi HSV: Â±5%
Perangkat: Kamera Android (Auto WB aktif)
Platform: Sistem MONTANA v2.1`);

  writeBlock('Referensi Ilmiah',
  `Richardson, A.D. et al. (2002). Remote Sensing of Environment.
Mahajan, G., Pandey, R. (2014). Agricultural Science Journal.
Adi, D. et al. (2020). Jurnal Agroteknologi Indonesia.
Li, Q. et al. (2022). Precision Agriculture.
Taiz, L., Zeiger, E. (2015). Plant Physiology and Development.`);

  writeBlock(' Verifikasi Teknis',
  `Diverifikasi oleh: Syahrudin
Jabatan: Teknisi Rehabilitasi & Revegetasi
Tanggal Verifikasi: ${waktu.split(',')[0]}`);

  /* ================= FOOTER ================= */
  doc.setFont('helvetica', 'italic');
  doc.setFontSize(9);
  doc.text('MONTANA â€” Halaman 1: Analisis Uji Laboratorium tetap lebih akurat', left, 825);

  doc.save(`laporan_kesehatan_daun_${reportId}.pdf`);
};


/* Init canvas */
dctx.fillStyle='#eef2f7'; dctx.fillRect(0,0,displayCanvas.width,displayCanvas.height);
</script>
</body>
</html>
