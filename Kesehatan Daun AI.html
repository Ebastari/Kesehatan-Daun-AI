backgroundColor:['#16a34a','#facc15','#b45309','#e5e7eb','#111827']
<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
<title>MONTANA â€” Chatbot Analisis Daun</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>

<style>
:root{
  --bg:#0b141a; --panel:#0f1a1f; --header:#162126; --ink:#e9edef; --muted:#aebac1;
  --bot:#1b2a31; --user:#dcf8c6; --accent:#00a884; --line:rgba(255,255,255,.08);
  --card:#152126; --danger:#fca5a5; --ok:#86efac;
  --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom);
}
@media (prefers-color-scheme: dark){
  :root{ color-scheme:dark; }
}
*{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
html,body{height:100%}
body{margin:0;font-family:'Inter',system-ui,Arial;background:var(--bg);color:var(--ink);overscroll-behavior-y:none}
.app{min-height:100svh;display:flex;flex-direction:column;background:var(--panel)}
.header{display:flex;gap:12px;align-items:center;background:var(--header);padding:12px 14px calc(12px + var(--safe-top));border-bottom:1px solid var(--line);position:sticky;top:0;z-index:5}
.header .avatar{width:38px;height:38px;border-radius:50%;object-fit:cover}
.header .title{font-weight:700;font-size:15px}
.header .sub{font-size:12px;color:var(--muted)}
.banner{padding:8px 14px;border-bottom:1px solid var(--line);color:var(--muted);font-size:13px}
.chat{flex:1;overflow-y:auto;scroll-behavior:smooth;padding:14px 10px;display:flex;flex-direction:column;gap:10px;background:var(--panel)}
.row{display:flex;width:100%}
.row.bot{justify-content:flex-start}
.row.user{justify-content:flex-end}
.bubble{border-radius:16px;padding:10px 12px;line-height:1.55;font-size:15px;max-width:92%;box-shadow:0 6px 18px rgba(0,0,0,.25)}
.bubble.bot{background:var(--bot);border-bottom-left-radius:6px}
.bubble.user{background:var(--user);color:#111;border-bottom-right-radius:6px}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px;color:#d4e2e7}
.thumb{width:100%;border-radius:10px;background:#0b0b0b}
.table{width:100%;border-collapse:collapse;margin-top:8px;font-size:13px}
.table th,.table td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:left}
.table th{color:#bcd0d7}
.badge{display:inline-flex;align-items:center;gap:6px;font-weight:700;padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
.ok{background:#163628;color:#9de7c6}
.bad{background:#3a1b1b;color:#f5a1a1}
.progress{height:10px;background:#132128;border-radius:999px;overflow:hidden;border:1px solid var(--line);margin-top:6px}
.progress>span{display:block;height:100%;background:linear-gradient(90deg,#22c55e,#16a34a);width:0}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.btn{padding:11px 12px;border-radius:12px;border:1px solid var(--line);background:#20363d;color:#e9edef;cursor:pointer;font-weight:700;font-size:14px}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
.legend-dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px;vertical-align:middle}
.hint{color:var(--muted);font-size:12px}
.k-pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:#1e2e35;border:1px solid var(--line);font-size:12px}
/* Bottom bar */
.bbar{position:sticky;bottom:0;background:#0f1e23;border-top:1px solid var(--line);padding:10px 12px calc(10px + var(--safe-bottom));display:flex;gap:10px;align-items:center}
.bbar .actions{display:flex;gap:10px;margin-left:auto}
.action{display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:999px;border:1px solid var(--line);background:#20363d;color:#e9edef;cursor:pointer;font-weight:800;font-size:15px;min-width:120px;justify-content:center}
.action.primary{background:var(--accent);border-color:var(--accent);color:#fff}
input[type=file]{display:none}
/* Hidden lab */
#lab{display:none}
/* Mobile tweaks */
@media (max-width:480px){
  .bubble{max-width:96%; font-size:15px}
  .btn{font-size:15px}
  .action{min-width:auto;padding:12px 14px}
}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <img class="avatar" src="https://i.pravatar.cc/150?img=5" alt="MONTANA">
    <div>
      <div class="title">MONTANA AI â€” Chatbot Analisis Kesehatan </div>
      <div class="sub"> Berdasarkan berbasis citra warna (HSV)</div>
    </div>
  </div>
  <div class="banner">Unggah foto / gunakan kamera. Bot akan menilai kesehatan daun, memprediksi penyebab (penyakit/hara), dan memberi rekomendasi.</div>
  <div id="chat" class="chat" aria-live="polite"></div>
  <div class="bbar">
    <div class="k-pill">Aksi cepat</div>
    <div class="actions">
      <label for="upload" class="action">ï¼‹ Upload</label>
      <button id="openCam" class="action primary">ðŸ“· Kamera</button>
    </div>
  </div>
</div>

<!-- hidden inputs -->
<input id="upload" type="file" accept="image/*" capture="environment">

<!-- Hidden lab (analitik) -->
<div id="lab" aria-hidden="true">
  <video id="video" autoplay playsinline muted></video>
  <canvas id="captureCanvas" width="320" height="320"></canvas>
  <canvas id="displayCanvas" width="320" height="320"></canvas>

  <span id="statusChip" class="badge ok" style="display:none">âœ” Sehat</span>
  <span id="statusChipBad" class="badge bad" style="display:none">âš  Tidak Sehat</span>
  <span id="score">â€”</span>
  <div class="progress"><span id="scoreBar"></span></div>
  <div id="healthLabel" class="hint">â€”</div>

  <div id="dominantBox"></div>
  <div id="analysisText"></div>
  <div id="controlAdvice"></div>
  <div id="nutrientNote"></div>

  <canvas id="chart" width="220" height="180"></canvas>

  <table>
    <tbody id="tableBody">
      <tr><td><span class="legend-dot" style="background:#16a34a"></span>Hijau (Sehat)</td><td id="cntSehat">0</td><td id="pctSehat">0%</td></tr>
      <tr><td><span class="legend-dot" style="background:#facc15"></span>Kuning</td><td id="cntKuning">0</td><td id="pctKuning">0%</td></tr>
     <tr><td><span class="legend-dot" style="background:#8B4513"></span>Coklat</td>
<td id="cntCoklat">0</td><td id="pctCoklat">0%</td></tr>
      <tr><td><span class="legend-dot" style="background:#e5e7eb;border:1px solid #cbd5e1"></span>Putih</td><td id="cntPutih">0</td><td id="pctPutih">0%</td></tr>
      <tr><td><span class="legend-dot" style="background:#111827"></span>Hitam</td><td id="cntHitam">0</td><td id="pctHitam">0%</td></tr>
    </tbody>
  </table>

  <button id="btnStart" type="button"></button>
  <button id="btnSwitch" type="button"></button>
  <button id="btnCapture" type="button"></button>
</div>

<script>
/* ---------- Chat helpers ---------- */
const chat = document.getElementById('chat');
function bubble(html, who='bot'){
  const row=document.createElement('div');
  row.className = `row ${who}`;
  const div=document.createElement('div');
  div.className = `bubble ${who}`;
  div.innerHTML = html;
  row.appendChild(div);
  chat.appendChild(row);
  chat.scrollTop = chat.scrollHeight;
  return div;
}
function card(html){ return bubble(`<div class="card">${html}</div>`,'bot'); }
const sayUser = (text)=> bubble(text,'user');

/* ---------- Elements (lab) ---------- */
const video = document.getElementById('video');
const capCanvas = document.getElementById('captureCanvas');
const cctx = capCanvas.getContext('2d');
const displayCanvas = document.getElementById('displayCanvas');
const dctx = displayCanvas.getContext('2d');
const upload = document.getElementById('upload');
const chartCanvas = document.getElementById('chart');

const scoreEl = document.getElementById('score');
const scoreBar = document.getElementById('scoreBar');
const labelEl = document.getElementById('healthLabel');
const chipOk = document.getElementById('statusChip');
const chipBad = document.getElementById('statusChipBad');

let currentStream=null, useFront=false, pieChart=null;
let gpsLocation='Tidak tersedia';

/* ---------- Quick welcome ---------- */
bubble('Halo! Kirim foto daun atau gunakan kamera. Aku akan menganalisis warna (HSV), menilai kesehatan, memprediksi penyebab (penyakit/hara), dan memberi rekomendasi ringkas.');

/* ---------- Camera minimal modal in chat ---------- */
const openCamBtn = document.getElementById('openCam');
openCamBtn.onclick = openCameraCard;

function openCameraCard(){
  const div = card(`
    <h4 style="margin:0 0 6px">ðŸ“· Kamera</h4>
    <video id="live" autoplay playsinline muted style="width:100%;max-height:300px;border-radius:12px;border:1px solid var(--line);background:#0b0b0b"></video>
    <div class="toolbar">
      <button class="btn" id="mSwitch">ðŸ”„ Ganti</button>
      <button class="btn primary" id="mShot">ðŸ“¸ Ambil</button>
      <button class="btn" id="mStop">âœ– Tutup</button>
    </div>
    <div class="hint">Jika gagal, cek izin kamera di browser Android.</div>
  `);
  const live = div.parentElement.querySelector('#live');
  const mSwitch = div.parentElement.querySelector('#mSwitch');
  const mShot   = div.parentElement.querySelector('#mShot');
  const mStop   = div.parentElement.querySelector('#mStop');

  async function startLive(){
    if (currentStream) currentStream.getTracks().forEach(t=>t.stop());
    try{
      const s = await navigator.mediaDevices.getUserMedia({ video:{ facingMode: useFront ? 'user':'environment' } });
      currentStream = s; live.srcObject = s;
    }catch(e){ alert('Tidak bisa membuka kamera. Gunakan Upload.'); }
  }
  startLive();
  mSwitch.onclick = ()=>{ useFront=!useFront; startLive(); };
  mShot.onclick = ()=>{
    if (!live.videoWidth){ alert('Kamera belum siap'); return; }
    cctx.drawImage(live, 0, 0, capCanvas.width, capCanvas.height);
    runAnalysis().then(renderResultToChat);
  };
  mStop.onclick = ()=>{ if(currentStream) currentStream.getTracks().forEach(t=>t.stop()); div.parentElement.parentElement.remove(); };
}

/* ---------- Upload ---------- */
upload.onchange = (e)=>{
  const f=e.target.files[0]; if(!f) return;
  sayUser('â¬†ï¸ Gambar terkirim');
  const reader=new FileReader(), img=new Image();
  reader.onload=()=> img.src = reader.result;
  img.onload=()=>{
    const cw=capCanvas.width, ch=capCanvas.height;
    const r=Math.min(cw/img.width, ch/img.height);
    const w=img.width*r, h=img.height*r;
    const dx=(cw-w)/2, dy=(ch-h)/2;
    cctx.fillStyle='#fff'; cctx.fillRect(0,0,cw,ch);
    cctx.drawImage(img, dx, dy, w, h);
    runAnalysis().then(renderResultToChat);
  };
  reader.readAsDataURL(f);
};

/* ---------- Analysis ---------- */
function rgbToHsv(r,g,b){
  r/=255; g/=255; b/=255;
  const max=Math.max(r,g,b), min=Math.min(r,g,b);
  let h=0,s=0,v=max, d=max-min;
  s = max===0 ? 0 : d/max;
  if (d!==0){
    if (max===r) h=((g-b)/d)%6;
    else if (max===g) h=(b-r)/d + 2;
    else h=(r-g)/d + 4;
    h=Math.round(h*60); if (h<0) h+=360;
  }
  return [h,Math.round(s*100),Math.round(v*100)];
}
function overlaySoft(){ dctx.fillStyle='rgba(34,197,94,0.12)'; dctx.fillRect(0,0,displayCanvas.width,displayCanvas.height); }
function runAnalysis(){
  dctx.drawImage(capCanvas,0,0,displayCanvas.width,displayCanvas.height);
  const w=capCanvas.width,h=capCanvas.height;
  const img=cctx.getImageData(0,0,w,h); const d=img.data;
  const cnt={sehat:0,kuning:0,coklat:0,putih:0,hitam:0}; let total=0;
  for (let i=0;i<d.length;i+=8){
    const r=d[i], g=d[i+1], b=d[i+2], a=d[i+3];
    if (a===0) continue;
    const [H,S,V]=rgbToHsv(r,g,b);
    if ((V>90 && S<20) || (V<10)) continue;
    total++;
    if (H>=60 && H<=160 && S>25 && V>25) cnt.sehat++;
    else if (H>=20 && H<60 && S>20 && V>30) cnt.kuning++;
    else if ((H<40 && S>25 && V<70)) cnt.coklat++;
    else if (V>=85 && S<=20) cnt.putih++;
    else if (V<=15) cnt.hitam++;
    else cnt.coklat++;
  }
  overlaySoft(); updateCounts(cnt,total); computeHealthAndAdvice(cnt,total);
  return Promise.resolve();
}
function updateCounts(cnt,total){
  const pct=k=> total?(cnt[k]/total*100):0;
  const pairs=[['Sehat','sehat'],['Kuning','kuning'],['Coklat','coklat'],['Putih','putih'],['Hitam','hitam']];
  pairs.forEach(([L,K])=>{
    document.getElementById('cnt'+L).textContent=cnt[K].toLocaleString();
    document.getElementById('pct'+L).textContent=pct(K).toFixed(2)+'%';
  });
  if (pieChart) { try{ pieChart.destroy(); }catch(e){} }
  pieChart=new Chart(chartCanvas.getContext('2d'),{type:'doughnut',
    data:{labels:['Hijau','Kuning','Coklat','Putih','Hitam'],
      datasets:[{data:[pct('sehat'),pct('kuning'),pct('coklat'),pct('putih'),pct('hitam')],
        backgroundColor:['#16a34a','#facc15','#b45309','#e5e7eb','#111827']
,borderWidth:0}]},
    options:{responsive:false,animation:false,cutout:'62%',plugins:{legend:{display:false}}}
  });
}
function computeHealthAndAdvice(cnt,total){
  const pct=k=> total?(cnt[k]/total*100):0;
  const pHijau=pct('sehat');
  const pKuning=pct('kuning'), pCoklat=pct('coklat'), pPutih=pct('putih'), pHitam=pct('hitam');
  const others=pKuning+pCoklat+pPutih+pHitam;
  let score=pHijau-0.7*others; score=Math.max(0,Math.min(100,score));
  scoreEl.textContent=score.toFixed(2);
  scoreBar.style.width = `${score}%`;
  if (score>50){ chipOk.style.display='inline-flex'; chipBad.style.display='none'; labelEl.innerHTML=`Status: <b>Sehat</b>`; }
  else{ chipOk.style.display='none'; chipBad.style.display='inline-flex'; labelEl.innerHTML=`Status: <b>Tidak Sehat</b>`; }

  const categories={'Hijau (Sehat)':pHijau,'Kuning':pKuning,'Coklat':pCoklat,'Putih':pPutih,'Hitam':pHitam};
  const dominant=Object.keys(categories).reduce((a,b)=>categories[a]>categories[b]?a:b);
  const domVal=categories[dominant].toFixed(2);
  const rec = diseaseRecommendation(dominant, {pHijau,pKuning,pCoklat,pPutih,pHitam,score});

  // simpan untuk PDF
  window.analysisData = {
    sehat: pHijau.toFixed(2), kuning: pKuning.toFixed(2),
    coklat: pCoklat.toFixed(2), putih: pPutih.toFixed(2),
    hitam: pHitam.toFixed(2), totalPixels: total,
    score: score.toFixed(2), dominant, dominantPct: domVal,
    diagnosis: rec.title, actions: rec.actions.join('\n')
  };
  window._lastRecommendation = rec;
}
/* ---------- Penyakit/Hara Recommender ---------- */
function diseaseRecommendation(dominant){
  if (dominant==='Kuning'){
    return {
      title:'Klorosis (defisiensi N/Mg/Fe) atau stres akar',
      causes:[
        'Kekurangan N â†’ daun kuning merata (tua duluan)',
        'Kekurangan Mg â†’ kuning antar tulang, tulang tetap hijau',
        'Akar tergenang â†’ klorosis menyebar cepat'
      ],
      actions:[
        'Tambahkan pupuk N bertahap (mis. 10â€“20 g Urea/tanaman, bagi 2â€“3 kali)',
        'Semprot MgSOâ‚„ 0.5% pada daun 1â€“2 kali/minggu bila gejala antar tulang',
        'Perbaiki drainase dan kurangi penyiraman sampai media gembur'
      ]
    };
  }
  if (dominant==='Coklat'){
    return {
      title:'Bercak daun jamur (Alternaria/Antraknosa) atau defisiensi Kalium',
      causes:[
        'Bercak coklat/tepi nekrosis â†’ infeksi jamur',
        'Pinggir daun mengering/terbakar â†’ kekurangan K'
      ],
      actions:[
        'Semprot fungisida protektif (mankozeb/klorotalonil) 5â€“7 hari sekali (pagi/sore)',
        'Tambahkan KCl/Kâ‚‚SOâ‚„ dosis ringan; hindari kelebihan N',
        'Buang daun terinfeksi parah, tingkatkan sirkulasi udara'
      ]
    };
  }
  if (dominant==='Putih'){
    return {
      title:'Powdery mildew (embun tepung) atau residu semprotan',
      causes:[
        'Lapisan putih keabu pada permukaan daun',
        'RH sedangâ€“tinggi & sirkulasi buruk memperparah'
      ],
      actions:[
        'Gunakan sulfur atau kalium bikarbonat (pagi/sore)',
        'Tingkatkan aerasi tajuk, hindari penyiraman mengenai daun',
        'Bersihkan residu dengan semprot air bersih halus'
      ]
    };
  }
  if (dominant==='Hitam'){
    return {
      title:'Hawar bakteri / nekrosis berat',
      causes:[
        'Bercak hitam tidak beraturan, jaringan mati',
        'Kelembapan tinggi & luka mekanik memperparah'
      ],
      actions:[
        'Pangkas dan musnahkan daun terinfeksi',
        'Aplikasikan bakterisida berbasis tembaga sesuai label',
        'Kurangi kelembapan, tingkatkan sirkulasi udara'
      ]
    };
  }
  return {
    title:'Kondisi fisiologis stabil',
    causes:['Mayoritas hijau, aktivitas fotosintesis baik.'],
    actions:['Pertahankan pemupukan & penyiraman seimbang','Monitoring mingguan']
  };
}

/* ---------- Hasil ke Chat ---------- */
function renderResultToChat(){
  const a = window.analysisData || {score:'0',dominant:'-',dominantPct:'0'};
  const photo = displayCanvas.toDataURL('image/png',0.9);
  // pastikan chart sudah dirender
  const ensureChartReady = ()=>{
    try{ return chartCanvas.toDataURL('image/png',0.95); }
    catch(e){ return ''; }
  };
  let chartURL = ensureChartReady();
  if (!chartURL || chartURL.length<50){
    // delay satu frame jika canvas belum siap
    setTimeout(()=>{
      const url2 = ensureChartReady();
      buildCard(url2);
    }, 30);
  } else {
    buildCard(chartURL);
  }

  function buildCard(cURL){
    const tableRows = Array.from(document.querySelectorAll('#tableBody tr')).map(tr=>{
      const t=tr.querySelectorAll('td'); return `<tr><td>${t[0].innerText}</td><td>${t[1].innerText}</td><td>${t[2].innerText}</td></tr>`;
    }).join('');
    const statusGood = parseFloat(a.score) > 50;
    const rec = window._lastRecommendation || {title:'â€”', causes:[], actions:[]};

    card(`
      <h4 style="margin:0 0 6px">ðŸ§ª Hasil Analisis</h4>
      <img src="${photo}" class="thumb" alt="Hasil Analisis">
      <div style="display:flex;align-items:center;gap:10px;margin-top:8px;flex-wrap:wrap">
        <span class="badge ${statusGood?'ok':'bad'}">${statusGood?'âœ” Sehat':'âš  Tidak Sehat'}</span>
        <div style="font-size:1.1rem;font-weight:800">Skor: ${a.score}</div>
      </div>
      <div class="progress"><span style="width:${a.score}%"></span></div>
      <div class="hint" style="margin-top:6px">Dominan: <b>${a.dominant}</b> (${a.dominantPct}%)</div>

      ${cURL?`<div style="margin-top:8px"><img src="${cURL}" alt="Diagram Warna" style="width:100%;max-width:320px;border-radius:10px;display:block;margin:auto"></div>`:''}

      <table class="table" style="margin-top:8px">
        <thead><tr><th>Kategori</th><th>Count</th><th>%</th></tr></thead>
        <tbody>${tableRows}</tbody>
      </table>

      <div style="margin-top:10px">
        <div class="k-pill">ðŸ©º Dugaan: <b>${rec.title}</b></div>
        ${rec.causes?.length?`<div class="hint" style="margin-top:6px"><b>Penyebab yang mungkin:</b><ul style="margin:6px 0 0 18px">${rec.causes.map(c=>`<li>${c}</li>`).join('')}</ul></div>`:''}
        ${rec.actions?.length?`<div class="hint" style="margin-top:6px"><b>Rekomendasi Tindakan:</b><ul style="margin:6px 0 0 18px">${rec.actions.map(c=>`<li>${c}</li>`).join('')}</ul></div>`:''}
      </div>

      <div class="toolbar">
        <button class="btn primary" id="dlPdf">â¬‡ Unduh PDF</button>
      </div>
    `);
    const btns = chat.querySelectorAll('#dlPdf');
    const lastBtn = btns[btns.length-1];
    if (lastBtn) lastBtn.onclick = generatePDF;
  }
}

/* ----------------------- Geolokasi --------------------- */
if (navigator.geolocation){
  navigator.geolocation.getCurrentPosition(p=>{
    gpsLocation = `${p.coords.latitude.toFixed(5)}, ${p.coords.longitude.toFixed(5)}`;
  },()=>{ gpsLocation='Tidak diizinkan'; });
}

/* -------- Util: Chart BW untuk PDF (grayscale) -------- */
function getBWChartDataURL(){
  const a=window.analysisData||{sehat:0,kuning:0,coklat:0,putih:0,hitam:0};
  const tmp=document.createElement('canvas'); tmp.width=220; tmp.height=160;
  const ctx=tmp.getContext('2d');
  new Chart(ctx,{type:'doughnut',
    data:{labels:['Hijau','Kuning','Coklat','Putih','Hitam'],
      datasets:[{data:[a.sehat,a.kuning,a.coklat,a.putih,a.hitam],
        backgroundColor:['#111','#333','#777','#bbb','#000'],borderWidth:0}]},
    options:{responsive:false,animation:false,cutout:'60%',plugins:{legend:{display:false},tooltip:{enabled:false}}}
  });
  return tmp.toDataURL('image/png',1.0);
}

// =============== PDF GENERATOR OTOMATIS & TEKNIS (KODE BARU) ===============
async function generatePDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'pt', format: 'a4' });
  const left = 50, right = 545;
  let y = 60;

  /* Helper paragraf */
  function writeTextBlock(text, size = 10, gapAfter = 10) {
    doc.setFontSize(size);
    const lines = doc.splitTextToSize(text, 495);
    doc.text(lines, left, y);
    y += lines.length * (size * 1.45) + gapAfter;
  }

  /* ================= HEADER ================= */
  doc.setFillColor(20);
  doc.rect(0, 0, 595, 55, 'F');
  doc.setFont('helvetica', 'bold');
  doc.setTextColor(255);
  doc.setFontSize(13);
  doc.text('LAPORAN ANALISIS KESEHATAN DAUN', 50, 28);
  doc.setFont('helvetica', 'normal');
  doc.setTextColor(240);
  doc.setFontSize(10);
  doc.text('PT Energi Batubara Lestari â€¢ Sistem MONTANA V2', 50, 42);
  doc.setTextColor(0);
  y = 70;

  /* ================= DATA ================= */
  const waktu = new Date().toLocaleString('id-ID', { timeZone: 'Asia/Makassar' });
  const reportId = 'RPT-' + new Date().toISOString().slice(0, 19).replace(/[-:T]/g, '').slice(0, 14);
  const a = window.analysisData || { score: '0', dominant: '-', dominantPct: '0', totalPixels: 0, sehat: 0, kuning: 0, coklat: 0, putih: 0, hitam: 0 };
  const gpsLoc = typeof gpsLocation === 'string' ? gpsLocation : 'Tidak tersedia';
  const scoreNum = parseFloat(a.score);
  const statusTxt = (scoreNum >= 60) ? 'Sehat' : (scoreNum >= 40 ? 'Mulai Stres' : 'Tidak Sehat');

  /* ================= RINGKASAN ================= */
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(11);
  writeTextBlock('Ringkasan Lapangan', 11, 4);
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(10);
  writeTextBlock(`No. Laporan: ${reportId}`);
  writeTextBlock(`Tanggal/Waktu (WITA): ${waktu}`);
  writeTextBlock(`Lokasi (GPS): ${gpsLoc}`);
  writeTextBlock(`Skor: ${a.score} | Status: ${statusTxt}`);
  writeTextBlock(`Dominan: ${a.dominant} (${a.dominantPct}%) | Total Piksel: ${Number(a.totalPixels || 0).toLocaleString()}`, 10, 16);
  doc.line(left, y, right, y);
  y += 20;

  /* ================= FOTO & CHART ================= */
  try {
    const imgData = displayCanvas.toDataURL('image/png', 1.0);
    doc.addImage(imgData, 'PNG', left, y, 230, 230);
  } catch {}
  try {
    const bwChart = getBWChartDataURL();
    doc.addImage(bwChart, 'PNG', left + 250, y, 230, 180);
  } catch {}
  y += 250;
  doc.line(left, y, right, y);
  y += 20;

  /* ================= TABEL ================= */
  const rows = [];
  document.querySelectorAll('#tableBody tr').forEach(tr => {
    const t = tr.querySelectorAll('td');
    rows.push([t[0].innerText, t[1].innerText, t[2].innerText]);
  });
  doc.autoTable({
    head: [['Kategori', 'Count', '%']],
    body: rows,
    startY: y,
    margin: { left },
    styles: { fontSize: 9, lineColor: [180, 180, 180] },
    headStyles: { fillColor: [240, 240, 240], textColor: [0, 0, 0] },
    theme: 'grid'
  });
  y = doc.lastAutoTable.finalY + 20;

  /* ================= FOOTER 1 ================= */
  doc.setFont('helvetica', 'italic');
  doc.setFontSize(9);
  doc.setTextColor(80);
  doc.text('MONTANA AI HALAMAN 2 â€” Analisis piksel bersifat indikatif; uji laboratorium tetap lebih akurat.', left, 825);

  /* ================= HALAMAN 2 ================= */
  doc.addPage();
  let y2 = 60;
  function writeBlock(title, text) {
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(11);
    doc.text(title, left, y2);
    y2 += 15;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9.5);
    const lines = doc.splitTextToSize(text, 495);
    doc.text(lines, left, y2);
    y2 += (lines.length * 14) + 10;
  }

  /* ================= DASAR ILMIAH ================= */
  writeBlock('Dasar Ilmiah Dan Metodologi Analisis',
  `Analisis kesehatan daun berbasis piksel merupakan metode non-destruktif untuk menilai kondisi fisiologis tanaman di lapangan tanpa perlu memetik daun. Pendekatan ini mengonversi ruang warna RGB ke HSV (Hue, Saturation, Value), karena HSV lebih stabil terhadap variasi cahaya dan kontras kamera. Setiap piksel citra (320Ã—320) dianalisis untuk menentukan kategori warnanya dengan ambang Hue, Saturation, dan Value yang telah dikalibrasi lapangan.`);

  /* ================= KLASIFIKASI WARNA ================= */
  writeBlock('Prinsip Klasifikasi Warna',
  `Hijau (Sehat): Hue 60â€“160Â°, S>25%, V>25% : jaringan aktif, klorofil tinggi.\nKuning: Hue 20â€“60Â°, S>20%, V>30% : indikasi defisiensi N atau Mg.\nCoklat: Hue 0â€“40Â°, S>25%, V<70% :nekrosis jaringan atau jamur.\nPutih: S<20%, V>85%  : residu pestisida atau pantulan cahaya.\nHitam: V<15% : jaringan mati atau kelembapan ekstrem.`);

  /* ================= RUMUS ================= */
  writeBlock('Rumus Penilaian Skor Kesehatan',
  `H = P_hijau - 0.7 Ã— (P_kuning + P_coklat + P_putih + P_hitam)\nBobot koreksi 0.7 menurunkan pengaruh warna non-hijau. Rentang nilai H: 0â€“100, di mana:\nH > 80  Sangat Sehat | 60-79 : Sehat | 40-59 : Mulai Stres | <40 : Tidak Sehat.`);

  /* ================= INTERPRETASI OTOMATIS ================= */
  let interpretasi = '';
  const dom = a.dominant || '';
  if (dom.includes('Coklat')) interpretasi = 'Daun menunjukkan dominasi coklat menandakan defisiensi K dan stres lingkungan.';
  else if (dom.includes('Kuning')) interpretasi = 'Daun mengalami klorosis ringan akibat defisiensi N/Mg atau drainase buruk.';
  else if (dom.includes('Putih')) interpretasi = 'Kemungkinan terdapat residu semprotan atau powdery mildew.';
  else if (dom.includes('Hitam')) interpretasi = 'Jaringan nekrotik akibat kelembapan ekstrem atau infeksi bakteri.';
  else interpretasi = 'Daun dalam kondisi fisiologis stabil dengan aktivitas fotosintesis baik.';

  writeBlock('Interpretasi & Keterbatasan',
  `${interpretasi} Nilai skor ${a.score} (${statusTxt}). Hasil bersifat indikatif dan dapat dipengaruhi oleh intensitas cahaya, kualitas kamera, kondisi daun, dan faktor genetik. Gunakan hasil ini sebagai deteksi dini sebelum uji jaringan dan analisis tanah untuk konfirmasi laboratorium.`);

  /* ================= KESIMPULAN OTOMATIS ================= */
  let tindakan = '';
  if (dom.includes('Coklat'))
    tindakan = `â€¢ Aplikasi pupuk dosis rendah (1-2 g/liter)\nâ€¢ Penyemprotan fungisida mankozeb/klorotalonil mingguan\nâ€¢ Pemantauan visual tiap 3â€“5 hari`;
  else if (dom.includes('Kuning'))
    tindakan = `â€¢ Tambah pupuk N dan Mg\nâ€¢ Pastikan drainase baik\nâ€¢ Uji jaringan daun untuk verifikasi nutrisi`;
  else if (dom.includes('Hitam'))
    tindakan = `â€¢ Buang daun rusak\nâ€¢ Aplikasikan bakterisida tembaga\nâ€¢ Tingkatkan sirkulasi udara`;
  else
    tindakan = `â€¢ Pertahankan pola pemupukan\nâ€¢ Monitoring rutin sistem MONTANA\nâ€¢ Uji jaringan daun per 3 bulan`;

  writeBlock('Kesimpulan Teknis Lapangan',
  `Berdasarkan analisis piksel metode HSV Color Segmentation, tanaman pada titik pengamatan menunjukkan skor ${a.score} (${statusTxt}). Warna dominan ${a.dominant} (${a.dominantPct}%) menjadi indikator kondisi fisiologis utama.\nTindakan korektif disarankan:\n${tindakan}`);

  /* ================= SPESIFIKASI & REFERENSI ================= */
  writeBlock('Spesifikasi Teknis Sistem',
  `Algoritma: HSV Color Segmentation v1.4\nResolusi Analisis: 320Ã—320 piksel\nSampling: setiap 2 piksel\nToleransi HSV: Â±5%\nPerangkat: Kamera Android (Auto WB aktif)\nPlatform: Sistem MONTANA v2.1`);

  writeBlock('Referensi Ilmiah',
  `Richardson, A.D. et al. (2002). Remote Sensing of Environment.\nMahajan, G., Pandey, R. (2014). Agricultural Science Journal.\nAdi, D. et al. (2020). Jurnal Agroteknologi Indonesia.\nLi, Q. et al. (2022). Precision Agriculture.\nTaiz, L., Zeiger, E. (2015). Plant Physiology and Development.`);

  writeBlock('Verifikasi Teknis',
  `Diverifikasi oleh: Syahrudin\nJabatan: Gl Nursery \nTanggal Verifikasi: ${waktu.split(',')[0]}`);

  /* ================= FOOTER 2 ================= */
  doc.setFont('helvetica', 'italic');
  doc.setFontSize(9);
  doc.text('MONTANA AI Halaman 2: Referensi Teknis', left, 825);

  doc.save(`laporan_kesehatan_daun_${reportId}.pdf`);
}

/* ---------- Init ---------- */
dctx.fillStyle='#0f1620'; dctx.fillRect(0,0,displayCanvas.width,displayCanvas.height);
</script>
</body>
</html>
